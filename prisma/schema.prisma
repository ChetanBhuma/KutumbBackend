generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  resource   String
  resourceId String?
  changes    String?
  ipAddress  String
  userAgent  String
  timestamp  DateTime @default(now())
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([resourceId])
  @@index([action])
  @@index([userId])
}

model Beat {
  id         String  @id @default(cuid())
  code       String  @unique
  name       String
  beatNumber String? // Beat number/identifier

  // Hierarchical Foreign Keys (for quick access)
  rangeId         String?
  districtId      String?
  subDivisionId   String?
  policeStationId String // Required FK

  // Location Details
  exactLocation String? // Exact location description
  landArea      String? // Land area covered (sq km)
  boundaries    Json? // GeoJSON boundaries

  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  Range         Range?          @relation(fields: [rangeId], references: [id], onDelete: Restrict)
  District      District?       @relation(fields: [districtId], references: [id], onDelete: Restrict)
  SubDivision   SubDivision?    @relation(fields: [subDivisionId], references: [id], onDelete: Restrict)
  PoliceStation PoliceStation   @relation(fields: [policeStationId], references: [id], onDelete: Restrict)
  BeatOfficer   BeatOfficer[]
  managedByOfficers BeatOfficer[] @relation("OfficerManagedBeats")
  SeniorCitizen SeniorCitizen[]
  Visit         Visit[]

  @@index([policeStationId])
  @@index([rangeId])
  @@index([districtId])
  @@index([subDivisionId])
  @@index([code])
  @@index([isActive])
}

model BeatOfficer {
  id              String       @id @default(cuid())
  name            String
  rank            String
  badgeNumber     String       @unique
  mobileNumber    String       @unique
  email           String?
  policeStationId String? // Made optional to support higher ranks
  beatId          String?
  rangeId         String? // New
  districtId      String? // New
  subDivisionId   String? // New
  designationId   String?
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  Beat            Beat?        @relation(fields: [beatId], references: [id])
  Designation     Designation? @relation(fields: [designationId], references: [id])

  PoliceStation   PoliceStation?           @relation(fields: [policeStationId], references: [id])
  Range           Range?                   @relation(fields: [rangeId], references: [id])
  District        District?                @relation(fields: [districtId], references: [id])
  SubDivision     SubDivision?             @relation(fields: [subDivisionId], references: [id])
  user            User?
  Visit           Visit[]                  @relation("OfficerVisits")
  Leave           OfficerLeave[]           @relation("OfficerLeaves")
  TransferHistory OfficerTransferHistory[] // Track officer transfers

  // Dynamic Jurisdiction Relations (Many-to-Many)
  managedRanges         Range[]         @relation("OfficerManagedRanges")
  managedDistricts      District[]      @relation("OfficerManagedDistricts")
  managedSubDivisions   SubDivision[]   @relation("OfficerManagedSubDivisions")
  managedPoliceStations PoliceStation[] @relation("OfficerManagedPoliceStations")
  managedBeats          Beat[]          @relation("OfficerManagedBeats")

  @@index([beatId])
  @@index([policeStationId])
  @@index([designationId])
  @@index([badgeNumber])
}

model Designation {
  id          String        @id @default(cuid())
  code        String        @unique
  name        String
  department  String
  level       Int           @default(1)
  description String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  BeatOfficer BeatOfficer[]

  @@index([department])
  @@index([isActive])
  @@index([level])
}

model District {
  id            String          @id @default(cuid())
  code          String          @unique
  name          String
  rangeId       String? // ForeignKey to Range
  range         String? // DEPRECATED: Keep for backward compat until migration complete
  area          String
  population    Int             @default(0)
  headquarters  String
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  PoliceStation PoliceStation[]
  SeniorCitizen SeniorCitizen[]
  SubDivision   SubDivision[]
  Range         Range?          @relation(fields: [rangeId], references: [id])
  BeatOfficer   BeatOfficer[]
  managedByOfficers BeatOfficer[] @relation("OfficerManagedDistricts")
  Beat          Beat[]

  @@index([isActive])
  @@index([rangeId])
}

model Range {
  id        String   @id @default(cuid())
  code      String   @unique // e.g., "CENTRAL", "NORTHERN"
  name      String // e.g., "Central Range"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  districts     District[]
  BeatOfficer   BeatOfficer[]
  managedByOfficers BeatOfficer[] @relation("OfficerManagedRanges")
  SeniorCitizen SeniorCitizen[]
  PoliceStation PoliceStation[]
  Beat          Beat[]

  @@index([code])
  @@index([isActive])
}

model SubDivision {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  districtId   String // Required FK
  area         String? // Area in sq km (optional)
  population   Int? // Population (optional)
  headquarters String? // Headquarters location (optional)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  District      District        @relation(fields: [districtId], references: [id], onDelete: Restrict)
  PoliceStation PoliceStation[]
  BeatOfficer   BeatOfficer[]
  managedByOfficers BeatOfficer[] @relation("OfficerManagedSubDivisions")
  SeniorCitizen SeniorCitizen[]
  Beat          Beat[]

  @@index([districtId])
  @@index([code])
  @@index([isActive])
}

model Document {
  id              String        @id @default(cuid())
  seniorCitizenId String
  documentType    String
  documentName    String
  fileUrl         String
  fileType        String
  fileSize        Int
  uploadedAt      DateTime      @default(now())
  SeniorCitizen   SeniorCitizen @relation(fields: [seniorCitizenId], references: [id], onDelete: Cascade)

  @@index([seniorCitizenId])
}

model EmergencyContact {
  id                 String        @id @default(cuid())
  seniorCitizenId    String
  name               String
  relation           String
  mobileNumber       String
  address            String?
  email              String?
  isPrimary          Boolean       @default(false)
  verificationStatus String        @default("Not Verified")
  verifiedAt         DateTime?
  createdAt          DateTime      @default(now())
  SeniorCitizen      SeniorCitizen @relation(fields: [seniorCitizenId], references: [id], onDelete: Cascade)

  @@index([seniorCitizenId])
}

model FamilyMember {
  id               String        @id @default(cuid())
  seniorCitizenId  String
  name             String
  age              Int?
  relation         String
  mobileNumber     String?
  isPrimaryContact Boolean       @default(false)
  createdAt        DateTime      @default(now())
  SeniorCitizen    SeniorCitizen @relation(fields: [seniorCitizenId], references: [id], onDelete: Cascade)

  @@index([seniorCitizenId])
}

model HealthCondition {
  id                  String          @id @default(cuid())
  code                String          @unique
  name                String
  description         String?
  severity            String          @default("MEDIUM")
  requiresSpecialCare Boolean         @default(false)
  isActive            Boolean         @default(true)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  SeniorCitizen       SeniorCitizen[] @relation("HealthConditions")

  @@index([isActive])
  @@index([severity])
}

model HouseholdHelp {
  id                 String        @id @default(cuid())
  seniorCitizenId    String
  staffType          String        @default("Domestic Help") // Domestic Help, Driver, Watchman, Tenant
  name               String
  mobileNumber       String?
  address            String?
  idProofType        String? // Aadhaar, VoterID, etc.
  idProofNumber      String?
  idProofUrl         String? // Uploaded document URL
  verificationStatus String        @default("Not Verified")
  startDate          DateTime?
  endDate            DateTime?
  remarks            String?
  employmentType     String        @default("Part-Time") // Full-Time, Part-Time, None
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  SeniorCitizen      SeniorCitizen @relation(fields: [seniorCitizenId], references: [id], onDelete: Cascade)

  @@index([seniorCitizenId])
  @@index([verificationStatus])
}

model LivingArrangement {
  id                String          @id @default(cuid())
  code              String          @unique
  name              String
  description       String?
  requiresCaretaker Boolean         @default(false)
  riskLevel         String          @default("LOW")
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  SeniorCitizen     SeniorCitizen[]

  @@index([isActive])
  @@index([riskLevel])
}

model MaritalStatus {
  id            String          @id @default(cuid())
  code          String          @unique
  name          String
  description   String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  SeniorCitizen SeniorCitizen[]

  @@index([isActive])
}

model PoliceStation {
  id      String  @id @default(cuid())
  code    String  @unique
  name    String
  address String
  phone   String?
  email   String?

  // Hierarchical Foreign Keys (all required for data integrity)
  rangeId       String
  districtId    String
  subDivisionId String

  // Location
  latitude  Float?
  longitude Float?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  Range         Range           @relation(fields: [rangeId], references: [id], onDelete: Restrict)
  District      District        @relation(fields: [districtId], references: [id], onDelete: Restrict)
  SubDivision   SubDivision     @relation(fields: [subDivisionId], references: [id], onDelete: Restrict)
  Beat          Beat[]
  BeatOfficer   BeatOfficer[]
  managedByOfficers BeatOfficer[] @relation("OfficerManagedPoliceStations")
  SeniorCitizen SeniorCitizen[]
  Visit         Visit[]

  @@index([code])
  @@index([rangeId])
  @@index([districtId])
  @@index([subDivisionId])
  @@index([isActive])
}

model RiskFactor {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  weight      Int      @default(1)
  category    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isActive])
}

model Role {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  permissions Permission[] @relation("RolePermissions") // Changed from String[] to relation
  isActive          Boolean  @default(true)
  jurisdictionLevel String   @default("NONE") // NONE, STATE, RANGE, DISTRICT, SUB_DIVISION, POLICE_STATION, BEAT
  isMultiSelect     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([isActive])
}

model SOSAlert {
  id              String        @id @default(cuid())
  seniorCitizenId String
  latitude        Float
  longitude       Float
  address         String?
  batteryLevel    Int?
  deviceInfo      Json?
  status          AlertStatus   @default(Active)
  respondedBy     String?
  respondedAt     DateTime?
  resolvedAt      DateTime?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  SeniorCitizen   SeniorCitizen @relation(fields: [seniorCitizenId], references: [id])

  locationUpdates SOSLocationUpdate[]

  @@index([createdAt])
  @@index([seniorCitizenId])
  @@index([status])
  @@index([status, createdAt]) // COMPOSITE: SLA tracking and control room dashboard
}

model SOSLocationUpdate {
  id           String   @id @default(cuid())
  sosAlertId   String
  latitude     Float
  longitude    Float
  batteryLevel Int?
  deviceInfo   Json?
  createdAt    DateTime @default(now())
  SOSAlert     SOSAlert @relation(fields: [sosAlertId], references: [id], onDelete: Cascade)

  @@index([sosAlertId])
}

model SeniorCitizen {
  id                            String         @id @default(cuid())
  fullName                      String
  dateOfBirth                   DateTime
  age                           Int
  gender                        String
  photoUrl                      String?
  maritalStatus                 String?
  occupation                    String?
  yearOfRetirement              Int?
  nationality                   String         @default("Indian")
  religion                      String?
  languagesKnown                String[]
  aadhaarNumber                 String?        @unique
  voterIdNumber                 String?
  panNumber                     String?
  passportNumber                String?
  healthId                      String?
  socialChatIds                 String?
  mobileNumber                  String         @unique
  alternateMobile               String?
  email                         String?
  preferredContactMode          String         @default("Call")
  permanentAddress              String
  presentAddress                String?
  pinCode                       String
  gpsLatitude                   Float?
  gpsLongitude                  Float?
  landmark                      String?
  rangeId                       String?
  districtId                    String?
  subDivisionId                 String?
  policeStationId               String?
  beatId                        String?
  livingArrangementId           String?
  livingArrangement             String?
  numberOfChildren              Int?
  consentToNotifyFamily         Boolean        @default(false)
  bloodGroup                    String?
  healthConditions              String[]
  allergies                     String?
  regularDoctor                 String?
  doctorContact                 String?
  healthInsurance               String?
  mobilityConstraints           String?
  consentShareHealth            Boolean        @default(false)
  registeredOnApp               Boolean        @default(false)
  deviceId                      String?
  appRegistrationDate           DateTime?
  consentNotifications          Boolean        @default(true)
  digitalCardIssued             Boolean        @default(false)
  digitalCardNumber             String?
  digitalCardIssueDate          DateTime?
  preferredVisitDay             String?
  preferredVisitTime            String?
  freeTime                      String? // Free time/availability for visits and activities
  visitNotes                    String?
  lastVisitDate                 DateTime?
  vulnerabilityLevel            String         @default("Low")
  interestedServices            String[]
  consentServiceRequest         Boolean        @default(true)
  consentDataUse                Boolean        @default(false)
  consentDate                   DateTime?
  signatureUrl                  String?
  applicationReceivedOn         DateTime       @default(now())
  receivedBy                    String?
  idVerificationStatus          IdentityStatus @default(Pending)
  officialRemarks               String?
  dataEntryCompletedBy          String?
  dataEntryDate                 DateTime?
  formCode                      String         @default("SC-REG-01")
  formVersion                   String         @default("v1.0")
  submissionType                String         @default("New")
  isActive                      Boolean        @default(true)
  createdAt                     DateTime       @default(now())
  updatedAt                     DateTime       @updatedAt
  userId                        String?        @unique
  maritalStatusId               String?
  aadhaarNoMasked               String?
  aadhaarVerified               Boolean        @default(false)
  addressLine1                  String?
  addressLine2                  String?
  allowDataExport               Boolean        @default(false)
  allowDataShareWithFamily      Boolean        @default(false)
  allowFamilyNotification       Boolean        @default(true)
  allowNotifications            Boolean        @default(true)
  beatCode                      String? // Consider removing if relation used
  // beatName - REMOVED (Use Beat.name)
  city                          String?
  consentAcceptedOn             DateTime?
  consentScheduledVisitReminder Boolean        @default(true)
  consentVersion                String?
  createdBy                     String?
  deletedBy                     String?
  deletedOn                     DateTime?
  digitalIdIssuedDate           DateTime?
  digitalQrCodeUrl              String?
  disabilityCertificateNo       String?
  // districtName - REMOVED (Use District.name)
  educationQualification        String?
  emergencyHospitalPreference   String?
  familyType                    String?
  geoJsonBeatId                 String?
  isMobileRegistered            Boolean        @default(false)
  isSoftDeleted                 Boolean        @default(false)
  lastAppLogin                  DateTime?
  lastAssessmentDate            DateTime?
  locality                      String?
  mobilityStatus                String?
  nextScheduledVisitDate        DateTime?
  physicalDisability            Boolean        @default(false)
  policePostCode                String?
  policePostName                String?
  // policeStationCode - REMOVED (Use PoliceStation.code)
  // policeStationName - REMOVED (Use PoliceStation.name)
  portalReferenceId             String?
  primaryDeviceId               String?
  primaryFamilyContactId        String?
  primaryFcmToken               String?
  // rangeName - REMOVED (Use District.range)
  registrationDate              DateTime?      @default(now())
  registrationNo                String?        @unique
  retiredFrom                   String?
  sourceSystem                  String?
  srCitizenUniqueId             String?        @unique
  state                         String?
  status                        String         @default("Pending")
  // subDivisionName - REMOVED Use relation
  updatedBy                     String?
  visitRemarks                  String?
  vulnerabilityScore            Int?
  // --- Master Data Alignment Fields (Truly Missing) ---
  whatsappNumber                String?
  nearbyFamilyDetails           String? // "Whether family members live nearby"
  healthInsuranceDetails        String? // Name, ID, etc.
  addressProofUrl               String? // URL of the uploaded address proof document

  Document             Document[]
  EmergencyContact     EmergencyContact[]
  FamilyMember         FamilyMember[]
  HouseholdHelp        HouseholdHelp[]
  SOSAlert             SOSAlert[]
  Beat                 Beat?                  @relation(fields: [beatId], references: [id])
  District             District?              @relation(fields: [districtId], references: [id])
  SubDivision          SubDivision?           @relation(fields: [subDivisionId], references: [id])
  Range                Range?                 @relation(fields: [rangeId], references: [id])
  LivingArrangement    LivingArrangement?     @relation(fields: [livingArrangementId], references: [id])
  MaritalStatus        MaritalStatus?         @relation(fields: [maritalStatusId], references: [id])
  PoliceStation        PoliceStation?         @relation(fields: [policeStationId], references: [id])
  User                 User?                  @relation(fields: [userId], references: [id])
  ServiceRequest       ServiceRequest[]
  SpouseDetails        SpouseDetails?
  Visit                Visit[]
  HealthCondition      HealthCondition[]      @relation("HealthConditions")
  MedicalHistory       MedicalHistory[]
  VulnerabilityHistory VulnerabilityHistory[]
  VisitRequest         VisitRequest[]
  CitizenRegistration  CitizenRegistration[]
  CitizenAuth          CitizenAuth[]
  VerificationRequest  VerificationRequest[]

  // New Fields for Legacy Form Alignment
  telephoneNumber String?
  specialization  String?
  // retiredFrom - Already exists
  residingWith    String? // Alone, With Spouse, etc.

  @@index([aadhaarNumber])
  @@index([beatId])
  @@index([mobileNumber])
  @@index([policeStationId])
  @@index([vulnerabilityLevel])
  @@index([districtId])
  @@index([subDivisionId])
  @@index([rangeId])
  @@index([isActive]) // PERFORMANCE: Critical for soft delete queries
  @@index([idVerificationStatus]) // PERFORMANCE: For approval workflows
  @@index([policeStationId, isActive]) // COMPOSITE: Common query pattern
}

model MedicalHistory {
  id              String        @id @default(cuid())
  seniorCitizenId String
  conditionName   String
  sinceWhen       String? // "2010", "Childhood", etc.
  remarks         String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  SeniorCitizen   SeniorCitizen @relation(fields: [seniorCitizenId], references: [id], onDelete: Cascade)

  @@index([seniorCitizenId])
}

model ServiceRequest {
  id              String        @id @default(cuid())
  seniorCitizenId String
  serviceType     String
  description     String
  status          RequestStatus @default(Pending)
  priority        String        @default("Normal")
  assignedTo      String?
  resolution      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  completedAt     DateTime?
  SeniorCitizen   SeniorCitizen @relation(fields: [seniorCitizenId], references: [id])

  @@index([priority])
  @@index([seniorCitizenId])
  @@index([status])
  @@index([assignedTo])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  ipAddress    String
  userAgent    String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SpouseDetails {
  id                   String        @id @default(cuid())
  seniorCitizenId      String        @unique
  fullName             String
  dateOfBirth          DateTime?
  age                  Int?
  gender               String?
  mobileNumber         String?
  email                String?
  socialChatIds        String?
  isLivingTogether     Boolean       @default(true)
  addressIfNotTogether String?
  relationshipStatus   String?
  interlinkingId       String?
  weddingDate          DateTime? // Wedding anniversary date
  SeniorCitizen        SeniorCitizen @relation(fields: [seniorCitizenId], references: [id], onDelete: Cascade)
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  phone          String         @unique
  passwordHash   String
  role           String         @default("CITIZEN")
  isActive       Boolean        @default(true)
  lastLogin      DateTime?
  mfaEnabled     Boolean        @default(false)
  mfaSecret      String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  officerId      String?        @unique
  officerProfile BeatOfficer?   @relation(fields: [officerId], references: [id])
  AuditLog       AuditLog[]
  SeniorCitizen  SeniorCitizen?
  Session        Session[]
  ApprovedLeaves OfficerLeave[] @relation("LeaveApprover")
  RejectedLeaves OfficerLeave[] @relation("LeaveRejecter")
  Notification   Notification[]
}

model Visit {
  id              String         @id @default(cuid())
  seniorCitizenId String
  officerId       String
  policeStationId String
  beatId          String?
  scheduledDate   DateTime
  completedDate   DateTime?
  status          VisitStatus    @default(SCHEDULED)
  visitType       String
  notes           String?
  priority        String?        @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  cancelledAt     DateTime? // Track when visit was cancelled
  cancelledBy     String? // Who cancelled the visit
  previousAddress String? // Store old address for re-verification context
  photoUrl        String?
  gpsLatitude     Float?
  gpsLongitude    Float?
  duration        Int?
  startedAt       DateTime?
  assessmentData  Json?
  riskScore       Float?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  Beat            Beat?          @relation(fields: [beatId], references: [id])
  officer         BeatOfficer    @relation("OfficerVisits", fields: [officerId], references: [id])
  PoliceStation   PoliceStation  @relation(fields: [policeStationId], references: [id])
  SeniorCitizen   SeniorCitizen  @relation(fields: [seniorCitizenId], references: [id])
  VisitFeedback   VisitFeedback?

  @@index([officerId])
  @@index([scheduledDate])
  @@index([seniorCitizenId])
  @@index([status])
  @@index([policeStationId])
  @@index([beatId])
  @@index([officerId, status]) // COMPOSITE: Officer dashboard queries
  @@index([status, scheduledDate]) // COMPOSITE: Scheduling views
}

model VisitType {
  id               String   @id @default(cuid())
  code             String   @unique
  name             String
  description      String?
  defaultDuration  Int      @default(30)
  requiresApproval Boolean  @default(false)
  priority         Int      @default(3)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([code])
  @@index([isActive])
  @@index([priority])
}

model VulnerabilityHistory {
  id            String        @id @default(cuid())
  citizenId     String
  score         Int
  level         String
  breakdown     Json
  triggeredBy   String
  createdAt     DateTime      @default(now())
  SeniorCitizen SeniorCitizen @relation(fields: [citizenId], references: [id])

  @@index([citizenId])
}

model VisitRequest {
  id                String               @id @default(cuid())
  seniorCitizenId   String
  preferredDate     DateTime?
  preferredTimeSlot String?
  visitType         String?
  notes             String?
  status            RequestStatus        @default(Pending)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  SeniorCitizen     SeniorCitizen        @relation(fields: [seniorCitizenId], references: [id])
  registrationId    String?
  registration      CitizenRegistration? @relation(fields: [registrationId], references: [id])

  @@index([seniorCitizenId])
  @@index([status])
}

model CitizenRegistration {
  id               String             @id @default(cuid())
  mobileNumber     String             @unique
  fullName         String?
  status           RegistrationStatus @default(IN_PROGRESS)
  registrationStep String             @default("START")
  otpVerified      Boolean            @default(false)
  draftData        Json?
  citizenId        String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  citizen       SeniorCitizen? @relation(fields: [citizenId], references: [id])
  visitRequests VisitRequest[]

  @@index([mobileNumber])
  @@index([status])
}

model VisitFeedback {
  id          String   @id @default(cuid())
  visitId     String   @unique
  rating      Int
  comments    String?
  submittedBy String
  createdAt   DateTime @default(now())
  Visit       Visit    @relation(fields: [visitId], references: [id])
}

model CitizenAuth {
  id                      String    @id @default(cuid())
  mobileNumber            String    @unique
  password                String
  otpCode                 String?
  otpExpiresAt            DateTime?
  otpAttempts             Int       @default(0)
  otpVerificationAttempts Int       @default(0) // Track failed OTP verification attempts
  otpLastSentAt           DateTime?
  isVerified              Boolean   @default(false)
  registrationStep        Int       @default(0)
  citizenId               String?
  loginAttempts           Int       @default(0)
  lockedUntil             DateTime?
  lastLoginAt             DateTime?
  lastLoginIP             String?
  refreshToken            String?
  refreshTokenExpiresAt   DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  citizen SeniorCitizen? @relation(fields: [citizenId], references: [id])

  @@index([mobileNumber])
  @@index([citizenId])
}

model VerificationRequest {
  id                 String             @id @default(cuid())
  entityType         String
  entityId           String
  seniorCitizenId    String
  requestedBy        String
  priority           String             @default("Normal")
  remarks            String?
  documents          String[]
  status             VerificationStatus @default(PENDING)
  assignedTo         String?
  assignedAt         DateTime?
  verifiedBy         String?
  verifiedAt         DateTime?
  verificationMethod String?
  verificationNotes  String?
  rejectionReason    String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  seniorCitizen SeniorCitizen @relation(fields: [seniorCitizenId], references: [id])

  @@index([seniorCitizenId])
  @@index([status])
  @@index([assignedTo])
}

model VulnerabilityConfig {
  id              String    @id @default(cuid())
  version         Int
  weights         Json
  isActive        Boolean   @default(true)
  notes           String?
  createdById     String?
  createdByName   String?
  publishedAt     DateTime?
  publishedById   String?
  publishedByName String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  bands VulnerabilityBand[]
}

model VulnerabilityBand {
  id                 String  @id @default(cuid())
  configId           String
  name               String
  label              String
  min                Int
  max                Int
  color              String?
  visitFrequencyDays Int

  config VulnerabilityConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
}

model OfficerLeave {
  id              String      @id @default(cuid())
  officerId       String
  startDate       DateTime
  endDate         DateTime
  leaveType       String // Annual, Sick, Emergency, Casual
  status          LeaveStatus @default(Pending) // Pending, Approved, Rejected, Cancelled
  reason          String?
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  officer  BeatOfficer @relation("OfficerLeaves", fields: [officerId], references: [id], onDelete: Cascade)
  approver User?       @relation("LeaveApprover", fields: [approvedBy], references: [id])
  rejecter User?       @relation("LeaveRejecter", fields: [rejectedBy], references: [id])

  @@index([officerId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([approvedBy])
}

model OfficerTransferHistory {
  id                  String   @id @default(cuid())
  officerId           String
  fromBeatId          String
  toBeatId            String
  fromPoliceStationId String
  toPoliceStationId   String
  effectiveDate       DateTime
  reason              String
  transferredBy       String?
  createdAt           DateTime @default(now())

  Officer BeatOfficer @relation(fields: [officerId], references: [id])

  @@index([officerId])
  @@index([effectiveDate])
  @@index([fromBeatId])
  @@index([toBeatId])
}

model SystemMaster {
  id        String   @id @default(cuid())
  type      String // GENDER, RELIGION, OCCUPATION, BLOOD_GROUP, RELATION, MOBILITY, SERVICE_TYPE
  code      String
  name      String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  metadata  Json? // Extra info if needed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, code])
  @@index([type])
  @@index([isActive])
}

// --- ENUMS ---

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
  IN_PROGRESS
}

enum VisitStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  IN_PROGRESS
  MISSED
}

enum IdentityStatus {
  Pending
  FieldVerified
  Verified
  Rejected
  Suspended
}

enum RegistrationStatus {
  IN_PROGRESS
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum RequestStatus {
  Pending
  In_Progress
  Resolved
  Closed
  Rejected
}

model SystemSetting {
  key         String   @id
  value       String
  description String?
  updatedBy   String?
  updatedAt   DateTime @updatedAt
}

enum AlertStatus {
  Active
  Responded
  Resolved
  FalseAlarm // FIXED: Changed from False_Alarm for consistency
}

enum LeaveStatus {
  Pending
  Approved
  Rejected
  Cancelled
}

// ============================================
// DYNAMIC PERMISSION SYSTEM
// ============================================

model PermissionCategory {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "dashboard", "citizens", "operations"
  name        String   // e.g., "Dashboard", "Citizens", "Operations"
  description String?
  icon        String?  // Icon name for UI (e.g., "Home", "Users", "Shield")
  displayOrder Int     @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions Permission[]

  @@index([code])
  @@index([displayOrder])
  @@index([isActive])
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "dashboard.admin.view", "citizens.read"
  name        String   // e.g., "View Admin Dashboard", "View Citizens"
  description String?

  // Hierarchical structure
  categoryId  String?
  parentId    String?  // For submenu permissions

  // Menu mapping
  menuPath    String?  // e.g., "/admin/dashboard", "/citizens"
  menuLabel   String?  // e.g., "Dashboard", "Citizens"
  menuIcon    String?  // Icon name (e.g., "Home", "Users")

  // Metadata
  displayOrder Int     @default(0)
  isActive    Boolean  @default(true)
  isMenuItem  Boolean  @default(false) // True if this should appear in menu
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  category    PermissionCategory? @relation(fields: [categoryId], references: [id])
  parent      Permission?         @relation("PermissionHierarchy", fields: [parentId], references: [id])
  children    Permission[]        @relation("PermissionHierarchy")

  roles       Role[]              @relation("RolePermissions")

  @@index([code])
  @@index([categoryId])
  @@index([parentId])
  @@index([displayOrder])
  @@index([isMenuItem])
  @@index([isActive])
}


model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("system") // system, alert, reminder, etc.
  priority  String   @default("normal") // low, normal, high, urgent
  isRead    Boolean  @default(false)
  data      Json?    // Optional payload for navigation/actions
  createdAt DateTime @default(now())

  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}
