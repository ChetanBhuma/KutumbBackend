"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.recalculateVulnerability = exports.getBandForScore = exports.calculateScore = exports.calculateFactors = exports.ensureDefaultConfig = exports.normalizeBands = exports.normalizeWeights = exports.BAND_NAMES = void 0;
const database_1 = require("../config/database");
const errorHandler_1 = require("../middleware/errorHandler");
exports.BAND_NAMES = ['low', 'medium', 'high'];
const DEFAULT_WEIGHTS = {
    health: 25,
    isolation: 20,
    domesticHelp: 15,
    hoursAlone: 15,
    onlineDependency: 10,
    overdueVisit: 15
};
const DEFAULT_BANDS = [
    { name: 'low', label: 'Low Risk', min: 0, max: 40, color: '#22c55e', visitFrequencyDays: 30 },
    { name: 'medium', label: 'Medium Risk', min: 41, max: 70, color: '#eab308', visitFrequencyDays: 14 },
    { name: 'high', label: 'High Risk', min: 71, max: 100, color: '#ef4444', visitFrequencyDays: 7 }
];
const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
const normalizeWeights = (weights) => {
    const result = { ...DEFAULT_WEIGHTS };
    if (!weights)
        return result;
    Object.keys(result).forEach((key) => {
        const value = Number(weights[key]);
        if (!Number.isNaN(value)) {
            result[key] = value;
        }
    });
    return result;
};
exports.normalizeWeights = normalizeWeights;
const normalizeBands = (bands) => {
    if (!bands || bands.length === 0) {
        return DEFAULT_BANDS;
    }
    return [...bands]
        .map((band) => ({
        ...band,
        visitFrequencyDays: band.visitFrequencyDays || 30,
        color: band.color || '#64748b'
    }))
        .sort((a, b) => a.min - b.min);
};
exports.normalizeBands = normalizeBands;
const ensureDefaultConfig = async () => {
    const existing = await database_1.prisma.vulnerabilityConfig.count();
    if (existing > 0)
        return;
    await database_1.prisma.vulnerabilityConfig.create({
        data: {
            version: 1,
            weights: DEFAULT_WEIGHTS,
            isActive: true,
            createdByName: 'System',
            publishedAt: new Date(),
            publishedByName: 'System',
            bands: {
                create: DEFAULT_BANDS.map((band) => ({
                    name: band.name,
                    label: band.label,
                    min: band.min,
                    max: band.max,
                    color: band.color,
                    visitFrequencyDays: band.visitFrequencyDays
                }))
            }
        }
    });
};
exports.ensureDefaultConfig = ensureDefaultConfig;
const calculateFactors = (citizen) => {
    const healthIssues = citizen.healthConditions?.length || 0;
    const healthScore = clamp(healthIssues * 5 +
        (citizen.physicalDisability ? 8 : 0) +
        (citizen.mobilityStatus?.toLowerCase().includes('bed') ? 7 : citizen.mobilityStatus?.toLowerCase().includes('wheelchair') ? 5 : 0), 0, 25);
    const living = citizen.livingArrangement?.toLowerCase() || '';
    let isolationScore = 10;
    if (living.includes('alone'))
        isolationScore = 20;
    else if (living.includes('spouse'))
        isolationScore = 14;
    else if (living.includes('family'))
        isolationScore = 8;
    isolationScore += citizen._count.FamilyMember === 0 ? 4 : 0;
    isolationScore = clamp(isolationScore, 5, 20);
    const domesticHelpScore = citizen._count.HouseholdHelp === 0 ? 15 : clamp(15 - citizen._count.HouseholdHelp * 5, 5, 15);
    let hoursAloneScore = living.includes('alone') ? 15 : living.includes('spouse') ? 10 : 6;
    hoursAloneScore = clamp(hoursAloneScore, 4, 15);
    const onlineDependencyScore = citizen.registeredOnApp || citizen.isMobileRegistered ? 6 : 9;
    let overdueScore = 10;
    if (!citizen.lastVisitDate) {
        overdueScore = 15;
    }
    else {
        const daysSince = Math.floor((Date.now() - citizen.lastVisitDate.getTime()) / (1000 * 60 * 60 * 24));
        if (daysSince > 60)
            overdueScore = 15;
        else if (daysSince > 30)
            overdueScore = 12;
        else if (daysSince > 14)
            overdueScore = 9;
        else
            overdueScore = 6;
    }
    return {
        health: healthScore,
        isolation: isolationScore,
        domesticHelp: domesticHelpScore,
        hoursAlone: hoursAloneScore,
        onlineDependency: onlineDependencyScore,
        overdueVisit: overdueScore
    };
};
exports.calculateFactors = calculateFactors;
const calculateScore = (factors, weights) => {
    const score = (factors.health / 25) * weights.health +
        (factors.isolation / 20) * weights.isolation +
        (factors.domesticHelp / 15) * weights.domesticHelp +
        (factors.hoursAlone / 15) * weights.hoursAlone +
        (factors.onlineDependency / 10) * weights.onlineDependency +
        (factors.overdueVisit / 15) * weights.overdueVisit;
    return Math.round(score);
};
exports.calculateScore = calculateScore;
const getBandForScore = (score, bands) => {
    const sorted = [...bands].sort((a, b) => a.min - b.min);
    return sorted.find((band) => score >= band.min && score <= band.max) || sorted[0];
};
exports.getBandForScore = getBandForScore;
/**
 * Recalculate and update vulnerability score for a citizen using active configuration
 */
const recalculateVulnerability = async (citizenId) => {
    await (0, exports.ensureDefaultConfig)();
    // 1. Get Active Config
    const activeConfig = await database_1.prisma.vulnerabilityConfig.findFirst({
        where: { isActive: true },
        orderBy: { version: 'desc' },
        include: { bands: true }
    });
    if (!activeConfig)
        throw new errorHandler_1.AppError('No active vulnerability configuration found', 500);
    const weights = (0, exports.normalizeWeights)(activeConfig.weights);
    const bands = (0, exports.normalizeBands)(activeConfig.bands);
    // 2. Get Citizen Data
    const citizen = await database_1.prisma.seniorCitizen.findUnique({
        where: { id: citizenId },
        select: {
            id: true,
            fullName: true,
            healthConditions: true,
            physicalDisability: true,
            mobilityStatus: true,
            livingArrangement: true,
            registeredOnApp: true,
            isMobileRegistered: true,
            lastVisitDate: true,
            vulnerabilityScore: true,
            vulnerabilityLevel: true,
            _count: {
                select: {
                    HouseholdHelp: true,
                    FamilyMember: true
                }
            }
        }
    });
    if (!citizen)
        throw new Error('Citizen not found');
    // 3. Calculate Score
    const factors = (0, exports.calculateFactors)(citizen);
    const totalScore = (0, exports.calculateScore)(factors, weights);
    const band = (0, exports.getBandForScore)(totalScore, bands);
    // 4. Update Citizen
    await database_1.prisma.seniorCitizen.update({
        where: { id: citizenId },
        data: {
            vulnerabilityLevel: band.label,
            vulnerabilityScore: totalScore,
            lastAssessmentDate: new Date()
        }
    });
    // 5. Log History
    await database_1.prisma.vulnerabilityHistory.create({
        data: {
            citizenId,
            score: totalScore,
            level: band.name,
            breakdown: factors,
            triggeredBy: 'system_recalculation'
        }
    });
    return { totalScore, level: band.label, breakdown: factors };
};
exports.recalculateVulnerability = recalculateVulnerability;
//# sourceMappingURL=vulnerabilityService.js.map