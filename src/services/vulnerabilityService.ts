import { prisma } from '../config/database';
import { AppError } from '../middleware/errorHandler';

export interface VulnerabilityWeights {
    health: number;
    isolation: number;
    domesticHelp: number;
    hoursAlone: number;
    onlineDependency: number;
    overdueVisit: number;
    [key: string]: number;
}

export interface VulnerabilityBandInput {
    name: 'low' | 'medium' | 'high' | 'critical';
    label: string;
    min: number;
    max: number;
    color?: string;
    visitFrequencyDays: number;
}


export interface Evaluation {
    citizenId: string;
    score: number;
    band: string;
    bandLabel: string;
}

export const BAND_NAMES = ['low', 'medium', 'high', 'critical'];

export interface CitizenForScoring {
    id: string;
    fullName: string;
    healthConditions: string[];
    physicalDisability: boolean;
    mobilityStatus: string | null;
    livingArrangement: string | null;
    registeredOnApp: boolean;
    isMobileRegistered: boolean;
    lastVisitDate: Date | null;
    vulnerabilityScore: number | null;
    vulnerabilityLevel: string | null;
    _count: {
        HouseholdHelp: number;
        FamilyMember: number;
    };
}

const DEFAULT_WEIGHTS: VulnerabilityWeights = {
    health: 25,
    isolation: 20,
    domesticHelp: 15,
    hoursAlone: 15,
    onlineDependency: 10,
    overdueVisit: 15
};

const DEFAULT_BANDS: VulnerabilityBandInput[] = [
    { name: 'low', label: 'Low', min: 0, max: 30, color: '#22c55e', visitFrequencyDays: 30 },
    { name: 'medium', label: 'Medium', min: 31, max: 50, color: '#eab308', visitFrequencyDays: 14 },
    { name: 'high', label: 'High', min: 51, max: 70, color: '#f97316', visitFrequencyDays: 7 },
    { name: 'critical', label: 'Critical', min: 71, max: 100, color: '#ef4444', visitFrequencyDays: 3 }
];

const clamp = (value: number, min: number, max: number) => Math.min(Math.max(value, min), max);

export const normalizeWeights = (weights?: Partial<VulnerabilityWeights> | null): VulnerabilityWeights => {
    const result: VulnerabilityWeights = { ...DEFAULT_WEIGHTS };
    if (!weights) return result;
    (Object.keys(result) as Array<keyof VulnerabilityWeights>).forEach((key) => {
        const value = Number(weights[key]);
        if (!Number.isNaN(value)) {
            result[key] = value;
        }
    });
    return result;
};

export const normalizeBands = (bands?: VulnerabilityBandInput[] | null): VulnerabilityBandInput[] => {
    if (!bands || bands.length === 0) {
        return DEFAULT_BANDS;
    }
    return [...bands]
        .map((band) => ({
            ...band,
            visitFrequencyDays: band.visitFrequencyDays || 30,
            color: band.color || '#64748b'
        }))
        .sort((a, b) => a.min - b.min);
};

export const ensureDefaultConfig = async () => {
    const existing = await prisma.vulnerabilityConfig.count();
    if (existing > 0) return;

    await prisma.vulnerabilityConfig.create({
        data: {
            version: 1,
            weights: DEFAULT_WEIGHTS,
            isActive: true,
            createdByName: 'System',
            publishedAt: new Date(),
            publishedByName: 'System',
            bands: {
                create: DEFAULT_BANDS.map((band) => ({
                    name: band.name,
                    label: band.label,
                    min: band.min,
                    max: band.max,
                    color: band.color,
                    visitFrequencyDays: band.visitFrequencyDays
                }))
            }
        }
    });
};

export const calculateFactors = (citizen: CitizenForScoring) => {
    const healthIssues = citizen.healthConditions?.length || 0;
    const healthScore = clamp(
        healthIssues * 5 +
        (citizen.physicalDisability ? 8 : 0) +
        (citizen.mobilityStatus?.toLowerCase().includes('bed') ? 7 : citizen.mobilityStatus?.toLowerCase().includes('wheelchair') ? 5 : 0),
        0,
        25
    );

    const living = citizen.livingArrangement?.toLowerCase() || '';
    let isolationScore = 10;
    if (living.includes('alone')) isolationScore = 20;
    else if (living.includes('spouse')) isolationScore = 14;
    else if (living.includes('family')) isolationScore = 8;
    isolationScore += citizen._count.FamilyMember === 0 ? 4 : 0;
    isolationScore = clamp(isolationScore, 5, 20);

    const domesticHelpScore = citizen._count.HouseholdHelp === 0 ? 15 : clamp(15 - citizen._count.HouseholdHelp * 5, 5, 15);

    let hoursAloneScore = living.includes('alone') ? 15 : living.includes('spouse') ? 10 : 6;
    hoursAloneScore = clamp(hoursAloneScore, 4, 15);

    const onlineDependencyScore = citizen.registeredOnApp || citizen.isMobileRegistered ? 6 : 9;

    let overdueScore = 10;
    if (!citizen.lastVisitDate) {
        overdueScore = 15;
    } else {
        const daysSince = Math.floor((Date.now() - citizen.lastVisitDate.getTime()) / (1000 * 60 * 60 * 24));
        if (daysSince > 60) overdueScore = 15;
        else if (daysSince > 30) overdueScore = 12;
        else if (daysSince > 14) overdueScore = 9;
        else overdueScore = 6;
    }

    return {
        health: healthScore,
        isolation: isolationScore,
        domesticHelp: domesticHelpScore,
        hoursAlone: hoursAloneScore,
        onlineDependency: onlineDependencyScore,
        overdueVisit: overdueScore
    };
};

export const calculateScore = (factors: ReturnType<typeof calculateFactors>, weights: VulnerabilityWeights) => {
    const score =
        (factors.health / 25) * weights.health +
        (factors.isolation / 20) * weights.isolation +
        (factors.domesticHelp / 15) * weights.domesticHelp +
        (factors.hoursAlone / 15) * weights.hoursAlone +
        (factors.onlineDependency / 10) * weights.onlineDependency +
        (factors.overdueVisit / 15) * weights.overdueVisit;

    return Math.round(score);
};

export const getBandForScore = (score: number, bands: VulnerabilityBandInput[]): VulnerabilityBandInput => {
    const sorted = [...bands].sort((a, b) => a.min - b.min);
    return sorted.find((band) => score >= band.min && score <= band.max) || sorted[0];
};

/**
 * Recalculate and update vulnerability score for a citizen using active configuration
 */
export const recalculateVulnerability = async (citizenId: string) => {
    await ensureDefaultConfig();

    // 1. Get Active Config
    const activeConfig = await prisma.vulnerabilityConfig.findFirst({
        where: { isActive: true },
        orderBy: { version: 'desc' },
        include: { bands: true }
    });

    if (!activeConfig) throw new AppError('No active vulnerability configuration found', 500);

    const weights = normalizeWeights(activeConfig.weights as any);
    const bands = normalizeBands(activeConfig.bands as any);

    // 2. Get Citizen Data
    const citizen = await prisma.seniorCitizen.findUnique({
        where: { id: citizenId },
        select: {
            id: true,
            fullName: true,
            healthConditions: true,
            physicalDisability: true,
            mobilityStatus: true,
            livingArrangement: true,
            registeredOnApp: true,
            isMobileRegistered: true,
            lastVisitDate: true,
            vulnerabilityScore: true,
            vulnerabilityLevel: true,
            _count: {
                select: {
                    HouseholdHelp: true,
                    FamilyMember: true
                }
            }
        }
    });

    if (!citizen) throw new Error('Citizen not found');

    // 3. Calculate Score
    const factors = calculateFactors(citizen);
    const totalScore = calculateScore(factors, weights);
    const band = getBandForScore(totalScore, bands);

    // 4. Update Citizen
    await prisma.seniorCitizen.update({
        where: { id: citizenId },
        data: {
            vulnerabilityLevel: band.label,
            vulnerabilityScore: totalScore,
            lastAssessmentDate: new Date()
        }
    });

    // 5. Log History
    await prisma.vulnerabilityHistory.create({
        data: {
            citizenId,
            score: totalScore,
            level: band.name,
            breakdown: factors as any,
            triggeredBy: 'system_recalculation'
        }
    });

    return { totalScore, level: band.label, breakdown: factors };
};

